<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Leaderboard ‚Äì Reflex The Box</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');
        body {
            margin: 0;
            background: linear-gradient(135deg, #22223b, #393e5a, #283e51);
            font-family: 'Poppins', sans-serif;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin-top: 40px;
            font-size: 2.8rem;
            letter-spacing: 2px;
            color: #ffd700;
            text-shadow: 0 0 12px #ffd70090;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .board {
            margin-top: 30px;
            background: rgba(44,83,100,0.75);
            border-radius: 18px;
            box-shadow: 0 0 30px #00ffe066;
            padding: 28px 32px 24px 32px;
            min-width: 320px;
            max-width: 440px;
        }
        ol {
            /* remove default list numbering so we can render a single custom index */
            list-style: none;
            padding: 0;
            margin: 0;
        }
        li {
            font-size: 1.25rem;
            margin: 10px 0;
            background: linear-gradient(90deg, #0f6b6a, #1aa79e);
            border-radius: 8px;
            padding: 8px 14px; /* a bit more horizontal padding */
            box-shadow: 0 2px 8px #ffd70044;
            color: #fffbe6;
            font-weight: 700;
            letter-spacing: 1px;
            list-style-type: none; /* ensure no marker */
        }
        .item-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .left { display:flex; align-items:center; gap:12px; }
        /* rank badge: small white pill with teal text like the screenshot */
        .rank {
            display:inline-flex;
            align-items:center;
            justify-content:center;
            min-width:28px;
            height:28px;
            border-radius:6px;
            background: #ffffff;
            color: #00c9a8;
            font-weight:900;
            font-size:0.95rem;
            padding: 0 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
        }
        .player-name { font-weight:800; color: #ffffff; }
        .score-val { font-weight:900; color: #ffffff; }
        .no-records {
            color: #cccccc;
            font-size: 1.1rem;
            text-align: center;
            margin: 22px 0;
        }
        .back-btn {
            margin-top: 18px;
            background: linear-gradient(145deg, #00ffe0, #00bfa5);
            color: #232526;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            padding: 12px 28px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 5px 18px #00bfa588;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .back-btn:hover {
            background: linear-gradient(145deg, #00bfa5, #00876d);
            color: #fff;
            box-shadow: 0 8px 25px #00876dcc;
        }
        .filter-row {
            display:flex;
            gap:12px;
            align-items:center;
            margin-bottom:12px;
        }
        .filter-row label {
            color:#cfeeea;
            font-weight:700;
        }
        select#speedFilter {
            padding:6px 10px;
            border-radius:14px;
            background: #ffffff;
            color: #003033;
            border: 2px solid #002f2f;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            font-weight:800;
            appearance: none;
        }
        .meta {
            font-size: 0.85rem;
            color: #cfeeea99;
            margin-top:6px;
            display:flex;
            justify-content:space-between;
        }
        .meta .time { opacity:0.9 }
        .clear-btn {
            margin-top: 12px;
            background: linear-gradient(145deg, #ff6b6b, #ff4b4b);
            color: #fff;
            border-radius: 10px;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-weight: 800;
            box-shadow: 0 6px 18px #ff4b4b44;
        }
        .clear-btn:hover { filter:brightness(0.95) }
        /* pulse animation for highlighted row */
        @keyframes pulse {
            0% { box-shadow: 0 6px 18px rgba(0,255,214,0.12); transform: translateY(0); }
            50% { box-shadow: 0 10px 30px rgba(0,255,214,0.18); transform: translateY(-2px); }
            100% { box-shadow: 0 6px 18px rgba(0,255,214,0.12); transform: translateY(0); }
        }
        .highlight {
            animation: pulse 1.2s ease-in-out infinite;
            background: linear-gradient(90deg, #30e0a8cc, #00ffd6bb);
            color: #042f2a;
            box-shadow: 0 4px 18px #00ffd666;
        }
        @media (max-width: 600px) {
            .board { min-width: 180px; max-width: 95vw; padding: 16px 8vw;}
            h1 { font-size: 2.1rem;}
            .back-btn { font-size: 1rem; padding: 10px 18px;}
            li { font-size: 1rem;}
        }
    </style>
</head>
<body>
<h1><span>üèÜ</span>Leaderboard</h1>
<div class="board">
    <div class="filter-row">
        <label for="speedFilter">Speed:</label>
        <select id="speedFilter">
            <option value="all">All</option>
            <option value="slow">üê¢ Slow</option>
            <option value="medium">‚ö° Medium</option>
            <option value="fast">üî• Fast</option>
        </select>
    </div>
    <ol id="leaderboardList"></ol>
    <div id="noRecords" class="no-records" style="display:none;">No records yet.</div>
</div>
<button class="back-btn" onclick="window.location.href='game.html'">‚Üê Back to Game</button>
<button id="clearBtn" class="clear-btn">Clear Leaderboard</button>
<script>
    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    // Build storage key for a speed
    function getKeyForSpeed(speed) {
        return `reflexBoxLeaderboard_${speed}`;
    }
    function loadEntriesForSelected(selected) {
        // if selected is 'all' combine slow/medium/fast
        const speeds = ['slow','medium','fast'];
        let items = [];
        if (selected === 'all') {
            speeds.forEach(s => {
                try { items = items.concat(JSON.parse(localStorage.getItem(getKeyForSpeed(s)) || '[]')); }
                catch (e) { /* ignore */ }
            });
        } else {
            try { items = JSON.parse(localStorage.getItem(getKeyForSpeed(selected)) || '[]'); }
            catch (e) { items = []; }
        }
        return Array.isArray(items) ? items : [];
    }

    function formatDateISO(ts) {
        try {
            const d = new Date(Number(ts) || Date.now());
            const pad = n => String(n).padStart(2, '0');
            const YYYY = d.getFullYear();
            const MM = pad(d.getMonth() + 1);
            const DD = pad(d.getDate());
            const hh = pad(d.getHours());
            const mm = pad(d.getMinutes());
            return `${YYYY}-${MM}-${DD} ${hh}:${mm}`;
        } catch (e) { return ''; }
    }

    const highlightTs = (function() {
        const v = getQueryParam('highlight_ts');
        if (!v) return null;
        const n = Number(v);
        return isFinite(n) ? n : null;
    })();

    // determine initial speed filter from query param and set control
    (function setInitialSpeedFromQuery() {
        const s = (getQueryParam('speed') || 'all').toLowerCase();
        if (['all','slow','medium','fast'].includes(s)) {
            speedFilter.value = s;
        } else {
            speedFilter.value = 'all';
        }
    })();

    function renderLeaderboard() {
        let lb = loadEntriesForSelected(speedFilter.value);
        // sanitize and filter
        let filtered = lb.filter(entry => entry && typeof entry.name === 'string' && typeof entry.score === 'number' && !isNaN(entry.score));
        filtered.sort((a, b) => (b.score - a.score) || (a.ts - b.ts));
        filtered = filtered.slice(0, 15);

        leaderboardList.innerHTML = '';
        if (filtered.length === 0) {
            noRecords.style.display = 'block';
        } else {
            noRecords.style.display = 'none';
            filtered.forEach((entry, idx) => {
                const name = escapeHtml(entry.name);
                const score = Number(entry.score) || 0;
                const timeStr = formatDateISO(entry.ts);
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-row">
                        <div class="left"><span class="rank">${idx+1}</span><span class="player-name">${name}</span></div>
                        <div class="score-val">${score}</div>
                    </div>
                    <div class="meta"><span class="time">${escapeHtml(timeStr)}</span><span style="text-transform:capitalize">${escapeHtml(entry.speed || '')}</span></div>
                `;
                // highlight if matches highlightTs
                if (highlightTs !== null && Number(entry.ts) === Number(highlightTs)) {
                    li.classList.add('highlight');
                    // after render, scroll into view
                    setTimeout(() => { li.scrollIntoView({behavior:'smooth', block:'center'}); }, 80);
                }
                leaderboardList.appendChild(li);
            });
        }
    }

    // adjust Clear button to remove per-speed keys
    const clearBtn = document.getElementById('clearBtn');
    clearBtn.addEventListener('click', () => {
        if (!confirm('Clear all leaderboard entries? This cannot be undone.')) return;
        try {
            ['slow','medium','fast'].forEach(s => localStorage.removeItem(getKeyForSpeed(s)));
            localStorage.removeItem('reflexBoxLeaderboard');
        } catch (e) { console.warn('Clear failed', e); }
        renderLeaderboard();
    });

    // Keep URL in sync when user changes filter (so shareable link)
    speedFilter.addEventListener('change', () => {
        const val = speedFilter.value;
        const params = new URLSearchParams(window.location.search);
        if (val === 'all') params.delete('speed'); else params.set('speed', val);
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        history.replaceState(null, '', newUrl);
        renderLeaderboard();
    });

    // initial render
    renderLeaderboard();

    // helper hidden element so static analyzer sees .highlight used (JS adds this class dynamically)
    const __h = document.createElement('div'); __h.className = 'highlight'; __h.style.display = 'none'; document.body.appendChild(__h);
</script>
</body>
</html>